<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flight Passenger Management</title>
<style>
:root {
    --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #64748b;
    --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    --light: #f8fafc; --dark: #1e293b; --border: #e2e8f0;
    --shadow: 0 2px 4px -1px rgba(0,0,0,0.1),0 1px 2px -1px rgba(0,0,0,0.06);
    --radius: 6px;
}
* {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body {background-color:#f1f5f9;color:var(--dark);line-height:1.5;padding:16px;}
.container {max-width:1400px;margin:0 auto;}
header {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.logo {display:flex;align-items:center;gap:10px;}
.logo-icon {width:36px;height:36px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;}
h1 {font-size:20px;font-weight:600;color:var(--dark);}
.main-content {display:grid;grid-template-columns:1fr 320px;gap:16px;margin-bottom:16px;}
.card {background:white;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px;}
.card-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.card-title {font-size:16px;font-weight:600;color:var(--dark);}
.form-group {margin-bottom:12px;}
label {display:block;margin-bottom:4px;font-weight:500;color:var(--secondary);font-size:13px;}
input,select,button {padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;transition:all 0.2s;}
input:focus,select:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(37,99,235,0.1);}
.btn {background:var(--primary);color:white;border:none;cursor:pointer;font-weight:500;display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:8px 12px;font-size:13px;}
.btn:hover {background:var(--primary-dark);}
.btn-success {background:var(--success);} .btn-success:hover {background:#0da271;}
.btn-danger {background:var(--danger);} .btn-danger:hover {background:#dc2626;}
.form-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;}
.flight-info-grid {display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px;}
.info-item {display:flex;flex-direction:column;}
.info-label {font-size:11px;color:var(--secondary);margin-bottom:4px;}
.info-value {font-weight:500;font-size:13px;}
.status-badge {display:inline-flex;align-items:center;padding:3px 10px;border-radius:16px;font-size:11px;font-weight:500;}
.status-open {background: rgba(16,185,129,0.1); color: var(--success);}
.status-closed {background: rgba(239,68,68,0.1); color: var(--danger);}
.flight-actions {display:flex;gap:10px;margin-top:12px;}
table {width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;}
th {background:var(--light);padding:10px;text-align:left;font-weight:600;color:var(--secondary);font-size:12px;border-bottom:1px solid var(--border);}
td {padding:10px;border-bottom:1px solid var(--border);font-size:13px;}
tr:hover {background: rgba(37,99,235,0.02);}
.editable-cell {background:#fff9db;border-radius:3px;padding:3px 6px;outline:none;}
.editable-cell:focus {background:#fff3bf;box-shadow:0 0 0 2px rgba(245,158,11,0.2);}
.actions-cell {display:flex;gap:6px;}
.icon-btn {background:none;border:none;cursor:pointer;padding:5px;border-radius:3px;display:flex;align-items:center;justify-content:center;color:var(--secondary);}
.icon-btn:hover {background:var(--light);color:var(--dark);}
.delete-btn {color:var(--danger);}
.delete-btn:hover {background: rgba(239,68,68,0.1);}
.empty-state {text-align:center;padding:30px 16px;color:var(--secondary);}
.empty-state-icon {font-size:36px;margin-bottom:12px;opacity:0.5;}
.stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px;}
.stat-card {background:white;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;}
.stat-value {font-size:20px;font-weight:700;margin-bottom:6px;}
.stat-label {font-size:12px;color:var(--secondary);}
@media (max-width:1024px){.main-content{grid-template-columns:1fr;}.stats-container{grid-template-columns:repeat(2,1fr);}}
@media (max-width:768px){.flight-info-grid{grid-template-columns:1fr;}.stats-container{grid-template-columns:repeat(2,1fr);}.form-row{grid-template-columns:1fr;}table{display:block;overflow-x:auto;}.actions-cell{flex-direction:column;}}
@media (max-width:480px){.stats-container{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo">
<div class="logo-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<path d="M22 16s-7-5-13-5-13 5-13 5 7 5 13 5 13-5 13-5z"></path>
<path d="M15 9l-3-3-3 3"></path>
<path d="M12 12l-3 3"></path>
</svg>
</div>
<h1>Flight Passenger Management</h1>
</div>
<div class="status-badge" id="globalStatusBadge">Status: Loading...</div>
</header>

<div class="main-content">
<div class="left-column">
<div class="card">
<div class="card-header">
<div class="card-title">Flight Selection</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="filterDate">Date</label>
<input type="date" id="filterDate">
</div>
<div class="form-group">
<label for="filterFlight">Flight Number</label>
<select id="filterFlight">
<option value="">Select Flight</option>
</select>
</div>
<div class="form-group" style="display:flex;align-items:flex-end;gap:5px;">
<button id="fetchBtn" class="btn">Fetch Data</button>
<button id="printBtn" class="btn">Print Report</button>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<div class="card-title">Passenger List</div>
<div class="passenger-count" id="passengerCount">0 passengers</div>
</div>

<div class="table-container">
<table id="reportTable">
<thead>
<tr>
<th>Name</th>
<th>Seat No</th>
<th>FQTV</th>
<th>Serial</th>
<th>Remarks</th>
<th>No. of Pax</th>
<th>Shift</th>
<th>Time Added</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
<div id="emptyState" class="empty-state" style="display:none;">
<div class="empty-state-icon">ðŸ‘¤</div>
<h3>No Passengers Found</h3>
<p>Select a date and flight number to view passenger data.</p>
</div>
</div>
</div>
</div>

<div class="right-column">
<div class="card">
<div class="card-header">
<div class="card-title">Flight Information</div>
<div class="status-badge" id="flightStatusBadge">Status: Open</div>
</div>

<div class="flight-info-grid">
<div class="info-item">
<span class="info-label">First Passenger Time</span>
<input type="time" id="firstPaxTimeInput">
</div>
<div class="info-item">
<span class="info-label">Scheduled Departure (STD)</span>
<input type="time" id="stdTimeInput">
</div>
<div class="info-item">
<span class="info-label">Last Passenger Left</span>
<input type="time" id="lastPaxTimeInput">
</div>
</div>

<div class="flight-actions">
<button id="toggleFlightBtn" class="btn btn-danger">Close Flight</button>
</div>
</div>
</div>
</div>

<div class="stats-container">
<div class="stat-card">
<div class="stat-value" id="totalPassengers">0</div>
<div class="stat-label">Total Passengers</div>
</div>
<div class="stat-card">
<div class="stat-value" id="firstPaxTime">--:--</div>
<div class="stat-label">First Passenger Time</div>
</div>
<div class="stat-card">
<div class="stat-value" id="stdTime">--:--</div>
<div class="stat-label">Scheduled Departure</div>
</div>
<div class="stat-card">
<div class="stat-value" id="lastPaxTime">--:--</div>
<div class="stat-label">Last Passenger Left</div>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="fire.js"></script>
<script src="Co.js"></script>

<script>



// DOM Elements
const tableBody=document.getElementById("tableBody"), fetchBtn=document.getElementById("fetchBtn"), printBtn=document.getElementById("printBtn"),
filterDate=document.getElementById("filterDate"), filterFlight=document.getElementById("filterFlight"), emptyState=document.getElementById("emptyState"),
passengerCount=document.getElementById("passengerCount"), totalPassengers=document.getElementById("totalPassengers"),
firstPaxTime=document.getElementById("firstPaxTime"), stdTime=document.getElementById("stdTime"), lastPaxTime=document.getElementById("lastPaxTime"),
firstPaxTimeInput=document.getElementById("firstPaxTimeInput"), stdTimeInput=document.getElementById("stdTimeInput"),
lastPaxTimeInput=document.getElementById("lastPaxTimeInput"), toggleFlightBtn=document.getElementById("toggleFlightBtn"),
flightStatusBadge=document.getElementById("flightStatusBadge"), globalStatusBadge=document.getElementById("globalStatusBadge");

let passengers=[], flightDocId=null, flightStatus="Open", flightListener=null;

// Set default date to today and populate flights
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
filterDate.value = `${yyyy}-${mm}-${dd}`;

// Populate flights for the default date
populateFlights();

// Populate Flights
async function populateFlights(){ const dateVal=filterDate.value; if(!dateVal) return;
const snapshot=await db.collection("passengers").where("date","==",dateVal).get();
const flights=[...new Set(snapshot.docs.map(doc=>doc.data().flightNo))];
filterFlight.innerHTML='<option value="">Select Flight</option>';
flights.forEach(f=>{ const option=document.createElement("option"); option.value=f; option.textContent=f; filterFlight.appendChild(option);});
if(flights.length>0) filterFlight.value=flights[0];}

// Fetch passengers
async function fetchPassengers(){ const dateVal=filterDate.value, flightVal=filterFlight.value;
if(!dateVal || !flightVal){ alert("Select date and flight!"); return;}
const snapshot=await db.collection("passengers").where("date","==",dateVal).where("flightNo","==",flightVal).get();
passengers=snapshot.docs.map(doc=>({...doc.data(), id:doc.id}));
renderTable(); updateStats(); listenFlightInfo(dateVal, flightVal);}

// Flight info listener
function listenFlightInfo(dateVal, flightVal){ if(flightListener) flightListener();
flightListener=db.collection("flightInfo").where("date","==",dateVal).where("flightNo","==",flightVal).limit(1)
.onSnapshot(snapshot=>{ if(!snapshot.empty){ const data=snapshot.docs[0].data();
flightDocId=snapshot.docs[0].id; flightStatus=data.status||"Open"; stdTimeInput.value=data.std||""; lastPaxTimeInput.value=data.lastPaxLeft||""; firstPaxTimeInput.value=data.firstPax||"";
updateFlightButtonLabel(); updateGlobalStatus();} else{ flightDocId=null; flightStatus="Open"; stdTimeInput.value=""; lastPaxTimeInput.value=""; firstPaxTimeInput.value="";
updateFlightButtonLabel(); updateGlobalStatus();}});}

// Render Table
function renderTable(){ if(passengers.length===0){ tableBody.innerHTML=""; emptyState.style.display="block"; passengerCount.textContent="0 passengers"; return;}
emptyState.style.display="none"; passengerCount.textContent=`${passengers.length} passenger${passengers.length!==1?'s':''}`; tableBody.innerHTML="";
passengers.forEach(p=>{ const row=document.createElement("tr"); ["name","seatNo","fqtv","serial","remarks","numPax","shift"].forEach(field=>{
const td=document.createElement("td"); const content=document.createElement("div"); content.className="editable-cell"; content.textContent=p[field]; content.contentEditable="true";
content.oninput=()=>{ p[field]=(field==="numPax"?parseInt(content.textContent)||1:content.textContent); };
content.onblur=async()=>{ await db.collection("passengers").doc(p.id).update({name:p.name,seatNo:p.seatNo,fqtv:p.fqtv,serial:p.serial,remarks:p.remarks,numPax:p.numPax,shift:p.shift});};
td.appendChild(content); row.appendChild(td);});
const actionsTd=document.createElement("td"); actionsTd.className="actions-cell";
const deleteBtn=document.createElement("button"); deleteBtn.className="icon-btn delete-btn"; deleteBtn.textContent="ðŸ—‘";
deleteBtn.onclick=async()=>{ await db.collection("passengers").doc(p.id).delete(); passengers=passengers.filter(pass=>pass.id!==p.id); renderTable(); updateStats(); };
actionsTd.appendChild(deleteBtn); row.appendChild(actionsTd);
tableBody.appendChild(row); });}

// Stats
function updateStats(){ totalPassengers.textContent=passengers.reduce((sum,p)=>sum+(p.numPax||0),0);
firstPaxTime.textContent=firstPaxTimeInput.value||"--:--"; stdTime.textContent=stdTimeInput.value||"--:--"; lastPaxTime.textContent=lastPaxTimeInput.value||"--:--"; }

function updateFlightButtonLabel(){ toggleFlightBtn.textContent=flightStatus==="Open"?"Close Flight":"Open Flight";
flightStatusBadge.textContent=`Status: ${flightStatus}`; flightStatusBadge.className=`status-badge ${flightStatus==="Open"?"status-open":"status-closed"}`; }

function updateGlobalStatus(){ globalStatusBadge.textContent=`Flight ${filterFlight.value||"--"} on ${filterDate.value||"--"}: ${flightStatus}`; }

toggleFlightBtn.addEventListener("click", async()=>{ if(!flightDocId){ alert("Flight info not found!"); return;}
flightStatus=flightStatus==="Open"?"Closed":"Open"; await db.collection("flightInfo").doc(flightDocId).update({
status:flightStatus,
firstPax:firstPaxTimeInput.value,
std:stdTimeInput.value,
lastPaxLeft:lastPaxTimeInput.value
});
updateFlightButtonLabel(); updateGlobalStatus(); });

fetchBtn.addEventListener("click", fetchPassengers); filterDate.addEventListener("change", populateFlights);

// Print report (updated layout)
printBtn.addEventListener("click", ()=>{
    if(passengers.length===0){ alert("No passengers to print!"); return; }

    const flightNo = filterFlight.value;
    const dateVal = filterDate.value;
    const firstPax = firstPaxTimeInput.value||"--:--";
    const lastPax = lastPaxTimeInput.value||"--:--";
    const std = stdTimeInput.value||"--:--";
    const shift = passengers.length>0 ? passengers[0].shift||"--" : "--";
    const airline = passengers.length>0 ? passengers[0].airline||"--" : "--";
    const totalPax = passengers.reduce((sum,p)=>sum+(p.numPax||0),0);

    const companyName = companyInfo?.name || "Company Name";
    const companyaddress = companyInfo?.address || "Company Address";
    const companyphone = companyInfo?.phone || "Company phone";

    let printWindow = window.open("","_blank");
    let html = `<html><head><title>Flight ${flightNo} Passenger Report</title>
    <style>
      body{font-family:sans-serif;padding:16px;}
      .header{display:flex;justify-content:space-between;margin-bottom:20px;}
      .header-left{line-height:1.5;}
      .header-right{line-height:1.5;text-align:right;}
      h2{text-align:center;margin-bottom:16px;}
      table{width:100%;border-collapse:collapse;margin-top:10px;}
      th,td{border:1px solid #000;padding:8px;text-align:left;}
      th{background:#eee;}
      .footer{margin-top:30px;display:flex;justify-content:space-between;}
    </style>
    </head><body>`;

    html+=`<h2>Passenger Report</h2>
    <div class="header">
      <div class="header-left">
        <strong>${companyName}</strong><br>
        <strong>${companyaddress}</strong><br>
        <strong>${companyphone}</strong><br>
        Flight No: ${flightNo}<br>
        Date: ${dateVal}<br>
        Airline: ${airline}
      </div>
      <div class="header-right">
        First Pax: ${firstPax}<br>
        Last Pax: ${lastPax}<br>
        STD: ${std}<br>
        Shift: ${shift}
      </div>
    </div>`;

    html+=`<table><thead><tr>
  <th>Name</th>
  <th>Seat No</th>
  <th>Pax</th>
  <th>FQTV</th>
  <th>Serial No</th>
  <th>Remarks</th>
</tr></thead><tbody>`;

passengers.forEach(p=>{
  html+=`<tr>
    <td>${p.name||""}</td>
    <td>${p.seatNo||""}</td>
    <td>${p.numPax||0}</td>
    <td>${p.fqtv||""}</td>
    <td>${p.serial||""}</td>
    <td>${p.remarks||""}</td>
  </tr>`;
    });

    html += `
    </tbody>
    <tfoot>
    <tr>
        <td colspan="1"><strong>Total</strong></td>
        <td colspan="1"><strong>${totalPax}</strong></td>
        <td colspan="4"></td>
    </tr>
    </tfoot>
    </table>

    <div style="margin-top:10px; font-size:11px; color:#555;">
        Any discrepancy should be notified within 48 hours. Any delay claims will not be accepted.
    </div>

    <div class="footer" style="margin-top:20px; display:flex; justify-content:space-between; font-size:12px;">
        <div>Prepared By: __________________</div>
        <div>Checked By: __________________</div>
    </div>
    </body>
    </html>`;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
});
</script>
</body>
</html>
